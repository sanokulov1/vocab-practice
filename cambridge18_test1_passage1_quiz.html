<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Default (Light) Mode Colors - Dark Teal for Page, Complementary for Quiz Box */
        :root {
            --primary-bg: #1A5276; /* Dark Teal for page background (Day Mode) */
            --secondary-bg: #EAF2F8; /* Light, complementary blue-gray for quiz container (Day Mode) */
            --text-primary: #333333; /* Dark grey for main text (Day Mode) */
            --text-secondary: #666666; /* Medium grey for less important text (Day Mode) */
            --accent-color: #3498DB; /* Brighter blue accent */
            --accent-light: #5DADE2; /* Lighter shade of accent for hover/active */
            --success-color: #28B463; /* Green for correct feedback */
            --error-color: #E74C3C; /* Red for incorrect feedback */
            --border-color: #CCD1D1; /* Light grey border */
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.15); /* Light shadow for elements */
            --input-bg: white; /* Background for input fields */
            --input-border: #D5DBDB; /* Border for input fields */
            --disabled-bg: #F2F4F4; /* Background for disabled elements */
            --disabled-text: #AAB7B8; /* Text for disabled elements */
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --primary-bg: #1F2937; /* Darker background for Dark Mode */
            --secondary-bg: #2D3748; /* Darker container background for Dark Mode */
            --text-primary: #E2E8F0; /* Light text for Dark Mode */
            --text-secondary: #A0AEC0; /* Lighter grey for secondary text */
            --accent-color: #63B3ED; /* Brighter blue accent for Dark Mode */
            --accent-light: #4299E1; /* Lighter shade of accent for hover/active */
            --success-color: #48BB78; /* Green for correct feedback in Dark Mode */
            --error-color: #FC8181; /* Red for incorrect feedback in Dark Mode */
            --border-color: #4A5568; /* Darker border for Dark Mode */
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.4); /* Darker shadow */
            --input-bg: #2D3748; /* Darker background for input fields */
            --input-border: #4A5568; /* Darker border for input fields */
            --disabled-bg: #1A202C; /* Background for disabled elements */
            --disabled-text: #667085; /* Text for disabled elements */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column; /* Changed to column to stack elements */
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            margin-top: 80px; /* Adjust for fixed elements like diamond count */
            margin-bottom: 40px; /* Space for navigation */
            box-sizing: border-box;
        }

        h1 {
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .instructions {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.1em;
            color: var(--text-secondary);
        }

        .question {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .question p {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .options label {
            display: block;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            color: var(--text-primary);
            font-size: 1em;
        }

        .options label:hover {
            background-color: var(--accent-light);
            color: white;
            border-color: var(--accent-color);
        }

        .options input[type="radio"] {
            margin-right: 10px;
            accent-color: var(--accent-color); /* Style for the radio button itself */
        }

        /* Feedback for correct/incorrect answers */
        .options label.correct-answer {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
            font-weight: bold;
        }

        .options label.incorrect-answer {
            background-color: var(--error-color);
            color: white;
            border-color: var(--error-color);
            font-weight: bold;
        }

        /* Disable options after check */
        .question.answered .options label {
            cursor: default;
        }
        .question.answered .options input[type="radio"] {
            pointer-events: none;
        }


        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        .navigation-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #prevBtn, #nextBtn {
            background-color: var(--accent-color);
            color: white;
        }

        #prevBtn:hover, #nextBtn:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
        }

        #prevBtn:disabled, #nextBtn:disabled, #checkBtn:disabled, #submitQuizBtn:disabled {
            background-color: var(--disabled-bg);
            color: var(--disabled-text);
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }

        #checkBtn, #submitQuizBtn {
            background-color: var(--success-color);
            color: white;
            display: none; /* Hidden by default */
        }
        #checkBtn:hover, #submitQuizBtn:hover {
            background-color: #2196F3; /* A bit different green for hover */
            transform: translateY(-2px);
        }

        /* Result Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--secondary-bg);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            box-shadow: var(--shadow-light);
            color: var(--text-primary);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 2em;
            color: var(--accent-color);
        }

        .modal-content p {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .modal-content button {
            background-color: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .modal-content button:hover {
            background-color: var(--accent-light);
        }

        /* Toggle Switch Styles */
        .theme-switch-wrapper {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            z-index: 10001; /* Above everything else */
        }

        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }

        .theme-switch input {
            display: none;
        }

        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }

        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
        }

        input:checked + .slider {
            background-color: #66bb6a;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            .question p {
                font-size: 1.1em;
            }
            .options label {
                padding: 10px;
            }
            .navigation-buttons button {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>

<div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider round"></div>
    </label>
</div>

<div class="container">
    <h1>Vocabulary Quiz</h1>
    <p class="instructions">Choose the correct definition for the highlighted word.</p>
    <div id="quiz-container">
        </div>
    <div class="navigation-buttons">
        <button id="prevBtn">Previous</button>
        <button id="nextBtn">Next</button>
        <button id="checkBtn">Check Answer</button>
        <button id="submitQuizBtn">Submit Quiz</button>
    </div>
</div>

<div id="resultModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle"></h2>
        <p id="modalMessage"></p>
        <button onclick="closeModal()">Close</button>
    </div>
</div>

<div id="diamond-count-container">
    <span id="diamond-count">0 💎</span>
</div>

<style>
#diamond-count-container {
    position: fixed;
    top: 20px;
    left: 20px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-family: 'Inter', sans-serif;
    font-size: 1.2em;
    font-weight: bold;
    z-index: 9999; /* Ensure it's above most content but below popup */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    display: flex; /* Use flexbox for better alignment */
    align-items: center;
    gap: 5px; /* Space between number and diamond emoji */
}

body.dark-mode #diamond-count-container {
    background-color: rgba(255, 255, 255, 0.2);
    color: #E2E8F0;
    border: 1px solid rgba(255, 255, 255, 0.3);
}
</style>

<style>
  #diamond-popup {
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: gold;
    color: black;
    font-weight: bold;
    font-size: 24px;
    padding: 15px 25px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: none;
    z-index: 9999;
    /* Basic animation for fade in/out */
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  #diamond-popup.show {
    opacity: 1;
  }
</style>
<div id="diamond-popup">+1 💎</div>

<div class="activity-nav">
    <div class="nav-buttons">
        <a href="cambridge18_test1_passage1_matching.html" class="nav-button prev-button">← Previous Activity</a>
        <a href="cambridge18_test1_passage1_typing.html" class="nav-button next-button">Next Activity →</a>
    </div>
    <div class="progress-indicator">
        <div class="progress-step matching-step">Matching</div>
        <div class="progress-step quiz-step">Quiz</div>
        <div class="progress-step typing-step">Typing</div>
    </div>
</div>

<style>
/* Unified Navigation Styles */
.activity-nav {
    max-width: 800px;
    margin: 40px auto 20px;
    padding: 0 20px;
}

.nav-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 25px;
}

.nav-button {
    padding: 14px 30px;
    border: none;
    border-radius: 10px;
    font-size: 1.15em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.prev-button {
    background: #3498DB;
    color: white;
}

.next-button {
    background: #28B463;
    color: white;
}

.nav-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

.nav-button:active {
    transform: translateY(0);
}

.progress-indicator {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-top: 10px;
}

.progress-indicator::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 4px;
    background: #E2E8F0;
    z-index: 1;
}

.progress-step {
    position: relative;
    z-index: 2;
    text-align: center;
    width: 33.33%;
    font-weight: 600;
    color: #A0AEC0;
}

.progress-step::before {
    content: '';
    width: 24px;
    height: 24px;
    background: #E2E8F0;
    border-radius: 50%;
    display: block;
    margin: 0 auto 10px;
    border: 4px solid white;
    box-shadow: 0 0 0 2px #E2E8F0;
}
.quiz-step {
    color: #2D3748;
}
.quiz-step::before {
    background: #3498DB;
    box-shadow: 0 0 0 2px #3498DB;
}
/* Dark mode adjustments */
body.dark-mode .progress-indicator::before {
    background: #4A5568;
}

body.dark-mode .progress-step::before {
    background: #4A5568;
    border-color: #1F2937;
    box-shadow: 0 0 0 2px #4A5568;
}

body.dark-mode .progress-step {
    color: #A0AEC0;
}

body.dark-mode .progress-step.matching-step::before,
body.dark-mode .progress-step.quiz-step::before,
body.dark-mode .progress-step.typing-step::before {
    background: #63B3ED;
    box-shadow: 0 0 0 2px #63B3ED;
}

body.dark-mode .matching-step,
body.dark-mode .quiz-step,
body.dark-mode .typing-step {
    color: #E2E8F0;
}
</style>

<script>
    // Theme toggle logic
    const toggleSwitch = document.getElementById('checkbox');
    const currentTheme = localStorage.getItem('theme');

    if (currentTheme) {
        document.body.classList.add(currentTheme);
        if (currentTheme === 'dark-mode') {
            toggleSwitch.checked = true;
        }
    }

    function switchTheme(e) {
        if (e.target.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light-mode');
        }
    }
    toggleSwitch.addEventListener('change', switchTheme);


    const quizData = [
        {
            word: "Serendipity",
            context: "Finding that rare book at a tiny, obscure shop was a moment of true <span class='highlight'>serendipity</span>.",
            options: [
                "The occurrence and development of events by chance in a happy or beneficial way.",
                "A state of deep thought or meditation.",
                "A sudden feeling of fear or dread.",
                "The act of intentionally causing harm to others."
            ],
            correctAnswer: "The occurrence and development of events by chance in a happy or beneficial way."
        },
        {
            word: "Ephemeral",
            context: "The beauty of the cherry blossoms is <span class='highlight'>ephemeral</span>, lasting only a few short weeks each spring.",
            options: [
                "Permanent and unchanging.",
                "Lasting for a very short time.",
                "Having a strong, pleasant smell.",
                "Relating to the study of ancient texts."
            ],
            correctAnswer: "Lasting for a very short time."
        },
        {
            word: "Luminous",
            context: "The full moon cast a <span class='highlight'>luminous</span> glow over the quiet lake.",
            options: [
                "Producing a harsh, grating sound.",
                "Covered in thick, dark shadows.",
                "Emitting or reflecting light; shining.",
                "Characterized by great depth or intensity."
            ],
            correctAnswer: "Emitting or reflecting light; shining."
        },
        {
            word: "Mellifluous",
            context: "Her voice was <span class='highlight'>mellifluous</span>, a soothing sound that captivated the audience.",
            options: [
                "Rough and unpleasant to the touch.",
                "Having a strong, bitter taste.",
                "Pleasant to hear.",
                "Full of twists and turns; winding."
            ],
            correctAnswer: "Pleasant to hear."
        },
        {
            word: "Sycophant",
            context: "The manager disliked the <span class='highlight'>sycophant</span> who constantly complimented him just to gain favors.",
            options: [
                "A person who avoids social interaction.",
                "A person who acts obsequiously toward someone important in order to gain advantage.",
                "A leader who inspires rebellion.",
                "A person who is skilled in multiple languages."
            ],
            correctAnswer: "A person who acts obsequiously toward someone important in order to gain advantage."
        }
    ];

    let currentQuestionIndex = 0;
    const quizContainer = document.getElementById('quiz-container');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const checkBtn = document.getElementById('checkBtn');
    const submitQuizBtn = document.getElementById('submitQuizBtn');
    const resultModal = document.getElementById('resultModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');

    const userAnswers = new Array(quizData.length).fill(null);
    const correctness = new Array(quizData.length).fill(null); // null: unchecked, true: correct, false: incorrect

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function loadQuestion() {
        const questionData = quizData[currentQuestionIndex];
        quizContainer.innerHTML = `
            <div class="question" id="question-${currentQuestionIndex}">
                <p>${questionData.context}</p>
                <div class="options">
                    ${shuffleArray([...questionData.options]).map((option, index) => `
                        <label>
                            <input type="radio" name="q${currentQuestionIndex}" value="${option}"
                                ${userAnswers[currentQuestionIndex] === option ? 'checked' : ''}>
                            ${option}
                        </label>
                    `).join('')}
                </div>
            </div>
        `;

        // Add event listener for radio button change
        const currentQuestionDiv = document.getElementById(`question-${currentQuestionIndex}`);
        currentQuestionDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                userAnswers[currentQuestionIndex] = event.target.value;
                checkBtn.style.display = 'inline-block'; // Show check button when an option is selected
                checkBtn.textContent = 'Check Answer'; // Reset button text
                checkBtn.disabled = false; // Enable check button
                // Reset correctness state and styling when answer changes
                correctness[currentQuestionIndex] = null;
                const optionsLabels = currentQuestionDiv.querySelectorAll('.options label');
                optionsLabels.forEach(label => {
                    label.classList.remove('correct-answer', 'incorrect-answer');
                });
                currentQuestionDiv.classList.remove('answered'); // Remove answered class
            });
        });

        updateNavigationButtons();
        applyFeedbackStyling();
    }

    function updateNavigationButtons() {
        prevBtn.disabled = currentQuestionIndex === 0;
        nextBtn.disabled = currentQuestionIndex === quizData.length - 1;

        if (currentQuestionIndex === quizData.length - 1 && userAnswers.every(answer => answer !== null)) {
            submitQuizBtn.style.display = 'inline-block';
        } else {
            submitQuizBtn.style.display = 'none';
        }

        // Hide Check/Submit buttons if the question has already been checked
        if (correctness[currentQuestionIndex] !== null) {
             checkBtn.style.display = 'none';
        } else if (userAnswers[currentQuestionIndex] !== null) {
            checkBtn.style.display = 'inline-block';
        } else {
            checkBtn.style.display = 'none';
        }
    }

    function checkAnswer() {
        const selectedAnswer = userAnswers[currentQuestionIndex];
        const questionData = quizData[currentQuestionIndex];
        const currentQuestionDiv = document.getElementById(`question-${currentQuestionIndex}`);

        if (selectedAnswer === null) {
            alert('Please select an answer before checking!');
            return;
        }

        const optionsLabels = currentQuestionDiv.querySelectorAll('.options label');
        optionsLabels.forEach(label => {
            const radio = label.querySelector('input');
            if (radio.value === questionData.correctAnswer) {
                label.classList.add('correct-answer');
            } else if (radio.value === selectedAnswer) {
                label.classList.add('incorrect-answer');
            }
        });

        if (selectedAnswer === questionData.correctAnswer) {
            correctness[currentQuestionIndex] = true;
        } else {
            correctness[currentQuestionIndex] = false;
        }

        currentQuestionDiv.classList.add('answered'); // Mark question as answered
        checkBtn.style.display = 'none'; // Hide check button after answer is revealed
        updateNavigationButtons(); // Update submit button visibility
    }

    function applyFeedbackStyling() {
        const questionData = quizData[currentQuestionIndex];
        const currentQuestionDiv = document.getElementById(`question-${currentQuestionIndex}`);
        const optionsLabels = currentQuestionDiv.querySelectorAll('.options label');

        if (correctness[currentQuestionIndex] !== null) { // If the question has been checked
            currentQuestionDiv.classList.add('answered');
            checkBtn.style.display = 'none'; // Hide check button

            optionsLabels.forEach(label => {
                const radio = label.querySelector('input');
                if (radio.value === questionData.correctAnswer) {
                    label.classList.add('correct-answer');
                } else if (radio.value === userAnswers[currentQuestionIndex]) { // If selected was incorrect
                    label.classList.add('incorrect-answer');
                }
            });
        }
    }

    function submitQuiz() {
        let score = 0;
        correctness.forEach(isCorrect => {
            if (isCorrect === true) {
                score++;
            }
        });

        modalTitle.textContent = 'Quiz Complete!';
        modalMessage.innerHTML = `You got ${score} out of ${quizData.length} questions correct.<br>Keep practicing!`;
        if (score === quizData.length) {
            modalTitle.textContent = 'Excellent!';
            modalMessage.innerHTML = `You got all ${quizData.length} questions correct! Amazing job!`;
        }

        resultModal.style.display = 'flex'; // Show modal

        // Trigger diamond update
        onQuizComplete(score);
    }

    function closeModal() {
        resultModal.style.display = 'none';
        currentQuestionIndex = 0;
        userAnswers.fill(null);
        correctness.fill(null);
        loadQuestion(); // Reload quiz
    }

    prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            loadQuestion();
        }
    });

    nextBtn.addEventListener('click', () => {
        if (currentQuestionIndex < quizData.length - 1) {
            currentQuestionIndex++;
            loadQuestion();
        }
    });

    checkBtn.addEventListener('click', checkAnswer);
    submitQuizBtn.addEventListener('click', submitQuiz);

    // Initial load
    loadQuestion();

</script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyChct6kCeqDlgbAuAJw3wP_tHOYN6gV-n4",
    authDomain: "website-vocabulary.firebaseapp.com",
    projectId: "website-vocabulary",
    storageBucket: "website-vocabulary.firebasestorage.app",
    messagingSenderId: "216286165163",
    appId: "1:216286165163:web:0d45648c2b998070a11fee",
    measurementId: "G-1RZLN9HJ65"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  window.auth = auth; // Expose to global window object for console debugging
  window.db = db;     // Expose to global window object for console debugging

  let startTime = Date.now();
  window.addEventListener("beforeunload", () => {
    const timeSpent = Math.floor((Date.now() - startTime) / 1000);
    const user = auth.currentUser;
    if (user) {
      const userRef = db.collection("users").doc(user.uid);
      userRef.update({
        timeSpent: firebase.firestore.FieldValue.increment(timeSpent),
        diamonds: firebase.firestore.FieldValue.increment(Math.floor(timeSpent / 3600) * 10)
      }).catch(error => {
        console.error("Error updating time spent/diamonds on unload:", error);
      });
    }
  });

  // Function to update diamond count display (top-left)
  async function updateDiamondCountDisplay(user) {
      const diamondCountElement = document.getElementById('diamond-count');
      if (diamondCountElement) {
          if (user) {
              const userRef = db.collection("users").doc(user.uid);
              try {
                  const docSnap = await userRef.get();
                  if (docSnap.exists) {
                      const diamonds = docSnap.data().diamonds || 0;
                      diamondCountElement.textContent = `${diamonds} 💎`;
                  } else {
                      diamondCountElement.textContent = '0 💎';
                  }
              } catch (error) {
                  console.error("Error fetching diamond count:", error);
                  diamondCountElement.textContent = 'Error 💎';
              }
          } else {
              diamondCountElement.textContent = '0 💎';
          }
      }
  }

  // Listen for auth state changes to update diamond count and potentially other UI
  auth.onAuthStateChanged((user) => {
      updateDiamondCountDisplay(user);
  });

  function showDiamondPopup(amount = 1) {
    const popup = document.getElementById("diamond-popup");
    popup.textContent = `+${amount} 💎`;
    popup.classList.add('show'); // Add 'show' class to trigger animation
    setTimeout(() => {
      popup.classList.remove('show'); // Remove 'show' to fade out
      // Hide completely after fade out animation (if needed for older browsers)
      setTimeout(() => { popup.style.display = "none"; }, 500); // Match transition duration
    }, 1500); // Total display time
    popup.style.display = "block"; // Make visible to start transition
  }

  function updateDiamondCount(diamondsEarned) {
    const user = auth.currentUser;
    if (!user) return;
    const userRef = db.collection("users").doc(user.uid);

    userRef.get().then(doc => {
      const current = doc.exists && doc.data().diamonds ? doc.data().diamonds : 0;
      userRef.set({ diamonds: current + diamondsEarned }, { merge: true })
        .then(() => {
          showDiamondPopup(diamondsEarned);
          updateDiamondCountDisplay(user); // Update top-left display after earning
        })
        .catch(error => {
          console.error("Error updating diamond count:", error);
        });
    }).catch(error => {
        console.error("Error getting user document for diamond update:", error);
    });
  }

  // Example hook (call this when an activity is completed)
  function onQuizComplete(correctAnswers) {
    if (correctAnswers >= 10) {
      updateDiamondCount(1.5);
    } else if (correctAnswers >= 7) {
      updateDiamondCount(1);
    }
  }

  function onTypingComplete(correctAnswers) {
    if (correctAnswers >= 10) {
      updateDiamondCount(1.5);
    } else if (correctAnswers >= 6) {
      updateDiamondCount(1);
    }
  }

  function onMatchingComplete() {
    updateDiamondCount(1);
  }
</script>

</body>
</html>